[gcode_macro M600]
description: Filament Change
variable_extruder: extruder
variable_filament_motor: motor1  ; Change this based on which motor is used

gcode:
    M83 ; Set extruder to relative mode

    # Move to a safe position
    G91 ; Relative positioning
    G1 Z10 ; Move Z up 10mm
    G90 ; Absolute positioning
    G1 X0 Y0 ; Move to the home position (adjust as needed)

    # Heat the hotend to the current printing temperature
    M104 S{printer.extruder.temperature} ; Set hotend temperature
    M109 S{printer.extruder.temperature} ; Wait for hotend to reach temperature

    # Unload filament using the specified filament motor
    G92 E0 ; Reset extruder position
    SET_STEPPER_ENABLE STEPPER={params.filament_motor} ENABLE=1 ; Enable the filament motor
    G1 E-100 F3000 ; Retract 100mm of filament at 3000mm/min

    # Monitor the filament sensor to ensure the filament is fully retracted
    {% set runout = False %}
    {% while not runout %}
        G1 E-10 F3000 ; Retract another 10mm
        G4 P500 ; Wait for 500ms
        {% set runout = printer['filament_switch_sensor extruder_sensor'].is_triggered %}
    {% endwhile %}

    # Disable the filament motor
    SET_STEPPER_ENABLE STEPPER={params.filament_motor} ENABLE=0 ; Disable the filament motor

    # Cool down the hotend slightly to prevent oozing
    M104 S150 ; Set hotend to a standby temperature of 150°C

    # Pause the print and wait for user to load new filament
    PAUSE

[gcode_macro RESUME]
description: Resume Print after Filament Change
variable_filament_motor: motor1  ; Change this based on which motor is used

gcode:
    M83 ; Set extruder to relative mode

    # Heat the hotend back to printing temperature
    M104 S{printer.extruder.temperature} ; Set hotend temperature
    M109 S{printer.extruder.temperature} ; Wait for hotend to reach temperature

    # Load new filament using the specified filament motor
    SET_STEPPER_ENABLE STEPPER={params.filament_motor} ENABLE=1 ; Enable the filament motor
    G1 E100 F3000 ; Push 100mm of filament at 3000mm/min

    # Monitor the filament sensor after the 4 into 1 tube to ensure filament is loaded
    {% set filament_loaded = False %}
    {% while not filament_loaded %}
        G1 E10 F3000 ; Push another 10mm
        G4 P500 ; Wait for 500ms
        {% set filament_loaded = printer['filament_switch_sensor tube_sensor'].is_triggered %}
    {% endwhile %}

    # Disable the filament motor
    SET_STEPPER_ENABLE STEPPER={params.filament_motor} ENABLE=0 ; Disable the filament motor

    # Clean the nozzle and resume print
    G92 E0 ; Reset extruder position
    G1 E10 F300 ; Extrude 10mm to clean the nozzle

    # Move back to the print position
    RESUME_PRINT



    [gcode_macro M600]
description: Filament Change
gcode:
    # Set extruder to relative mode
    M83

    # Move to a safe position
    G91 ; Relative positioning
    G1 Z10 ; Move Z up 10mm
    G90 ; Absolute positioning
    G1 X0 Y0 ; Move to the home position (adjust as needed)

    # Heat the hotend to the current printing temperature
    M104 S{printer.extruder.temperature} ; Set hotend temperature
    M109 S{printer.extruder.temperature} ; Wait for hotend to reach temperature

    # Unload filament
    G92 E0 ; Reset extruder position
    G1 E-100 F3000 ; Retract 100mm of filament at 3000mm/min

    # Monitor the filament sensor to ensure the filament is fully retracted
    {% set runout = False %}
    {% while not runout %}
        G1 E-10 F3000 ; Retract another 10mm
        G4 P500 ; Wait for 500ms
        {% set runout = printer['filament_switch_sensor extruder_sensor'].is_triggered %}
    {% endwhile %}

    # Cool down the hotend slightly to prevent oozing
    M104 S150 ; Set hotend to a standby temperature of 150°C

    # Pause the print and wait for user to load new filament
    PAUSE

[gcode_macro RESUME]
description: Resume Print after Filament Change
gcode:
    # Set extruder to relative mode
    M83

    # Heat the hotend back to printing temperature
    M104 S{printer.extruder.temperature} ; Set hotend temperature
    M109 S{printer.extruder.temperature} ; Wait for hotend to reach temperature

    # Load new filament
    G1 E100 F3000 ; Push 100mm of filament at 3000mm/min

    # Monitor the filament sensor after the 4 into 1 tube to ensure filament is loaded
    {% set filament_loaded = False %}
    {% while not filament_loaded %}
        G1 E10 F3000 ; Push another 10mm
        G4 P500 ; Wait for 500ms
        {% set filament_loaded = printer['filament_switch_sensor tube_sensor'].is_triggered %}
    {% endwhile %}

    # Clean the nozzle and resume print
    G92 E0 ; Reset extruder position
    G1 E10 F300 ; Extrude 10mm to clean the nozzle

    # Move back to the print position
    RESUME_PRINT
